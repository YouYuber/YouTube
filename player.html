<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube検索＆視聴＋履歴</titile>
  <link rel="stylesheet" href="stylesheet.css"> 
  <link rel="stylesheet" href="player.css"> 
  <script src="script.js"></script>
</head>
<body>
  <header>
	  <h1>YouTubeプレイヤー</h1>
	  <span class="badge">HTML5+CSS3+JavaScrpit</span>
	  <div class="btn-container"><button id="btn3" class="button">使い方</button></div>
	  <div id="mask" class="hidden"></div> <section id="modal" class="hidden">
		  <h1 class="h1">使い方</h1> 
		  <p>1. 検索欄にキーワードを入力して「検索して再生」を押すか、YouTubeのURL又はIDを貼り付け、動画をプレイヤーに読み込ませて再生します。</p>
		  <p>2. 公式のプレイヤーのため、字幕や画質変更なども可能です。</p> <h1 class="h1-1">注意事項</h1>
		  <p>・本ページはYouTubeの公式プレイヤーを使用していますが、「YouTube」及び「Google」又はそれに準ずるサービスに関係はありません。閉鎖やページの削除に関しましてはご了承ください。</p> 
		  <p>・現時点では検索欄にキーワードを入力しても、検索機能はご利用することはできません。恐れ入りますが、Web等でURL又はIDを検索したうえで本サービスをご利用ください。</p> 
		  <p>・本サービスはローカル環境では稼働しません。必ず、サイトの保存はせずに使用してください。</p> 
		  <p>
	  </section>
  </header>
  <main class="app">
    <section class="panel">
      <div class="controls">
        <label class="input">🔎<input id="query" type="text" placeholder="キーワード検索（YouTube埋め込み）" /></label>
        <button class="btn primary" id="searchBtn">検索して再生</button>
        <button class="btn" id="clearBtn">クリア</button>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="input">🔗<input id="urlInput" type="text" placeholder="YouTubeのURLまたは動画IDを貼り付け" /></label>
        <button class="btn" id="loadUrlBtn">URLを読み込み</button>
      </div>
      <div class="player" style="margin-top:12px">
        <iframe id="player"
          src="https://www.youtube.com/embed?listType=search&list=%E3%83%88%E3%83%AC%E3%83%B3%E3%83%89"
          allowfullscreen></iframe>
      </div>
	</section>
    <section class="panel">
      <h2 style="font-size:16px;margin:0 0 10px">📜 閲覧履歴</h2>
      <ul id="historyList" style="list-style:none;padding:0;margin:0;"></ul>
      <button class="btn" id="clearHistoryBtn">履歴クリア</button>
    </section>

    <p class="footer">© 2025 — インテル最高ｩｩ</p>
  </main>

  <script>
    const qs = sel => document.querySelector(sel);
    const player = qs('#player');
    const queryInput = qs('#query');
    const urlInput = qs('#urlInput');

    let history = JSON.parse(localStorage.getItem('ytHistory') || '[]');

    // 履歴表示更新
    function updateHistoryUI() {
      const list = qs('#historyList');
      list.innerHTML = '';
      history.forEach((item, idx) => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = item.url;
        a.textContent = `${idx+1}. ${item.title} — ${item.author}`;
        a.target = "_blank";

        const delBtn = document.createElement('button');
        delBtn.textContent = "削除";
        delBtn.className = "btn";
        delBtn.addEventListener('click', () => {
          history.splice(idx,1);
          localStorage.setItem('ytHistory', JSON.stringify(history));
          updateHistoryUI();
        });

        li.appendChild(a);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    // oEmbedで動画情報取得
    async function fetchOEmbedInfo(videoId) {
      const url = `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("oEmbed取得失敗");
        const data = await res.json();
        return {
          title: data.title,
          author: data.author_name,
          url: `https://www.youtube.com/watch?v=${videoId}`
        };
      } catch {
        return { title: videoId, author: "", url: `https://www.youtube.com/watch?v=${videoId}` };
      }
    }

    // 履歴追加
    async function addToHistory(id) {
      const info = await fetchOEmbedInfo(id);
      history.unshift(info);
      if (history.length > 20) history = history.slice(0,20);
      localStorage.setItem('ytHistory', JSON.stringify(history));
      updateHistoryUI();
    }

    // 検索再生
    function setPlayerToSearch(q) {
      const safe = encodeURIComponent(q.trim());
      if (!safe) return;
      player.src = `https://www.youtube.com/embed?listType=search&list=${safe}`;
    }

    // URL/IDから動画ID抽出
    function extractVideoId(input) {
      const s = input.trim();
      if (!s) return null;
      if (/^[a-zA-Z0-9_-]{11}$/.test(s)) return s;
      try {
        const u = new URL(s);
        if (u.hostname.includes('youtu.be')) {
          const id = u.pathname.split('/').filter(Boolean)[0];
          if (id && /^[a-zA-Z0-9_-]{11}$/.test(id)) return id;
        }
        if (u.searchParams.has('v')) {
          const id = u.searchParams.get('v');
          if (id && /^[a-zA-Z0-9_-]{11}$/.test(id)) return id;
        }
        if (u.pathname.includes('/embed/')) {
          const id = u.pathname.split('/').pop();
          if (id && /^[a-zA-Z0-9_-]{11}$/.test(id)) return id;
        }
        return null;
      } catch { return null; }
    }

    // 動画再生
    async function setPlayerToVideo(id) {
      player.src = `https://www.youtube.com/embed/${id}`;
      await addToHistory(id);
    }

    // イベント設定
    qs('#searchBtn').addEventListener('click', () => setPlayerToSearch(queryInput.value));
    qs('#clearBtn').addEventListener('click', () => {
      queryInput.value = '';
      urlInput.value = '';
      player.src = 'https://www.youtube.com/embed?listType=search&list=%E3%83%88%E3%83%AC%E3%83%B3%E3%83%89';
    });
    qs('#loadUrlBtn').addEventListener('click', () => {
      const id = extractVideoId(urlInput.value);
      if (!id) { alert('有効なYouTubeのURLまたは動画IDを入力してください。'); return; }
      setPlayerToVideo(id);
    });
    queryInput.addEventListener('keydown', e => { if (e.key === 'Enter') setPlayerToSearch(queryInput.value); });
    urlInput.addEventListener('keydown', e => { if (e.key === 'Enter') qs('#loadUrlBtn').click(); });
    qs('#clearHistoryBtn').addEventListener('click', () => {
      history = [];
      localStorage.removeItem('ytHistory');
      updateHistoryUI();
    });

    // 初期化
    updateHistoryUI();
  </script>
</body>
</html>
